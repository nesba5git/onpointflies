<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fly Catalog - On Point Flies</title>
    <meta name="description" content="Browse our complete catalog of hand-tied fly fishing flies. Streamers, nymphs, dry flies and more.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="api.js"></script>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">On Point <span>Flies</span></a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="catalog.html" class="active">Catalog</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="order.html">Order</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="account.html" id="account-link">Account</a></li>
            </ul>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span><span></span><span></span>
            </button>
        </div>
    </nav>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="hero-bg" style="background-image: url('https://images.pexels.com/photos/1089234/pexels-photo-1089234.jpeg?auto=compress&cs=tinysrgb&w=1920');"></div>
        <div class="hero-content">
            <span class="section-label">Browse Patterns</span>
            <h1>Fly Catalog</h1>
            <p>Explore our collection of hand-tied flies designed to catch fish in any water.</p>
        </div>
    </section>

    <!-- Catalog Section -->
    <section class="section">
        <div class="container">
            <!-- Search -->
            <div class="search-wrap">
                <input type="text" id="searchInput" placeholder="Search flies by name, type, or species...">
            </div>

            <!-- Filters -->
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all">All Flies</button>
                <button class="filter-btn" data-filter="Streamer">Streamers</button>
                <button class="filter-btn" data-filter="Nymph">Nymphs</button>
                <button class="filter-btn" data-filter="Dry Fly">Dry Flies</button>
                <button class="filter-btn" data-filter="Material">Materials</button>
            </div>

            <!-- Catalog Grid -->
            <div class="catalog-grid" id="catalog-grid"></div>

            <!-- Empty State -->
            <div id="empty-state" style="display:none;text-align:center;padding:3rem;color:var(--color-text-light);">
                <p style="font-size:1.1rem;">No flies match your search. Try a different term.</p>
            </div>
        </div>
    </section>

    <!-- CTA -->
    <section class="cta-banner">
        <div class="hero-bg" style="background-image: url('greysen-johnson-cZVzzFadTMc-unsplash.jpg');"></div>
        <div class="cta-content">
            <h2>Don't See What You Need?</h2>
            <p>We specialize in custom orders. Tell us what you're after and we'll tie it for you.</p>
            <div class="cta-buttons">
                <a href="order.html" class="btn btn-primary">Custom Orders</a>
                <a href="contact.html" class="btn btn-outline">Get in Touch</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-brand">
                <h3>On Point <span>Flies</span></h3>
                <p>Premium hand-tied flies for the passionate fly fisher. From classic patterns to custom creations, we tie flies that catch fish.</p>
            </div>
            <div>
                <h4>Navigate</h4>
                <ul class="footer-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="catalog.html">Catalog</a></li>
                    <li><a href="inventory.html">Inventory</a></li>
                </ul>
            </div>
            <div>
                <h4>Orders</h4>
                <ul class="footer-links">
                    <li><a href="order.html">How to Order</a></li>
                    <li><a href="order.html">Pricing</a></li>
                    <li><a href="order.html">Shipping</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <div>
                <h4>Get in Touch</h4>
                <ul class="footer-links">
                    <li><a href="mailto:info@onpointflies.com">info@onpointflies.com</a></li>
                    <li style="margin-top:0.5rem;"><a href="contact.html">Send us a message &rarr;</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 On Point Flies. All rights reserved.</p>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Auth0 Configuration
        var AUTH0_CONFIG = {
            domain: 'dev-ofdinri72f360yav.us.auth0.com',
            clientId: 'cFJGoFKtK0pgeR16J2fmX4saKHy8I86V',
            redirectUri: window.location.origin + '/catalog.html'
        };

        var auth0Client = null;
        var isAuthenticated = false;
        var cachedFavorites = []; // In-memory cache of user's favorites

        // Initialize Auth0
        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: AUTH0_CONFIG.domain,
                    clientId: AUTH0_CONFIG.clientId,
                    cacheLocation: 'localstorage',
                    authorizationParams: { redirect_uri: AUTH0_CONFIG.redirectUri }
                });

                if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                isAuthenticated = await auth0Client.isAuthenticated();
                updateAccountLink();

                if (isAuthenticated) {
                    await OPF_API.setToken(auth0Client);
                    // Sync user with database
                    try { await OPF_API.syncUser(); } catch(e) { console.error('User sync:', e); }
                    // Migrate any old localStorage data
                    await OPF_API.migrateLocalData();
                    // Load favorites from database for heart icon state
                    try {
                        cachedFavorites = await OPF_API.getFavorites();
                    } catch(e) { console.error('Load favorites:', e); }
                    // Re-render with favorites state
                    renderFlies(allFlies);
                }
            } catch (error) {
                console.error('Auth0 error:', error);
            }
        }

        function updateAccountLink() {
            var link = document.getElementById('account-link');
            if (isAuthenticated) {
                link.innerHTML = '&#128100; My Account';
            }
        }

        // Toast notifications
        function showToast(message, type) {
            type = type || 'success';
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(function() { toast.className = 'toast'; }, 3000);
        }

        // Favorites Management (Database-backed)
        function isFavorite(flyName) {
            return cachedFavorites.some(function(f) { return f.name === flyName; });
        }

        async function toggleFavorite(fly) {
            if (!isAuthenticated) {
                showToast('Please log in to save favorites', 'info');
                setTimeout(function() { window.location.href = 'account.html'; }, 1500);
                return;
            }

            var index = cachedFavorites.findIndex(function(f) { return f.name === fly.name; });

            try {
                if (index > -1) {
                    await OPF_API.removeFavorite(fly.name);
                    cachedFavorites.splice(index, 1);
                    showToast('Removed from favorites');
                } else {
                    await OPF_API.addFavorite(fly);
                    cachedFavorites.push(fly);
                    showToast('Added to favorites!');
                }
                renderFlies(allFlies);
            } catch (err) {
                showToast('Failed to update favorites', 'error');
                console.error('Favorite error:', err);
            }
        }

        // Shopping List Management (Database-backed)
        async function addToList(fly) {
            if (!isAuthenticated) {
                showToast('Please log in to use shopping lists', 'info');
                setTimeout(function() { window.location.href = 'account.html'; }, 1500);
                return;
            }

            try {
                var result = await OPF_API.addToShoppingList(fly);
                if (result.quantity) {
                    showToast('Added another ' + fly.name + ' (' + result.quantity + ' total)');
                } else {
                    showToast('Added to shopping list!');
                }
            } catch (err) {
                showToast('Failed to add to list', 'error');
                console.error('Shopping list error:', err);
            }
        }

        // Catalog
        var navbar = document.getElementById('navbar');
        window.addEventListener('scroll', function() { navbar.classList.toggle('scrolled', window.scrollY > 50); });
        var navToggle = document.getElementById('navToggle');
        var navLinks = document.getElementById('navLinks');
        navToggle.addEventListener('click', function() { navLinks.classList.toggle('open'); });

        var allFlies = [];
        var activeFilter = 'all';

        fetch('flies.json')
            .then(function(r) { return r.json(); })
            .then(function(flies) {
                allFlies = flies;
                renderFlies(flies);
                initAuth0();
            })
            .catch(function(err) { console.error('Error loading catalog:', err); });

        function renderFlies(flies) {
            var grid = document.getElementById('catalog-grid');
            var empty = document.getElementById('empty-state');
            grid.innerHTML = '';

            // Apply current filter
            var filtered = flies;
            var query = document.getElementById('searchInput').value.toLowerCase();
            if (activeFilter !== 'all') {
                filtered = filtered.filter(function(f) { return f.type === activeFilter; });
            }
            if (query) {
                filtered = filtered.filter(function(f) {
                    return f.name.toLowerCase().includes(query) ||
                        f.type.toLowerCase().includes(query) ||
                        f.bestFor.toLowerCase().includes(query) ||
                        f.description.toLowerCase().includes(query);
                });
            }

            if (filtered.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            filtered.forEach(function(fly, i) {
                var card = document.createElement('div');
                card.className = 'card animate-on-scroll';
                card.style.transitionDelay = Math.min(i * 0.05, 0.4) + 's';
                card.setAttribute('data-type', fly.type);

                var hasRecipe = fly.recipe && fly.recipe.trim().length > 0;
                var recipePreview = hasRecipe
                    ? '<details style="margin-top:0.75rem;"><summary style="cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--color-primary-light);">View Recipe</summary><pre style="margin-top:0.5rem;white-space:pre-wrap;font-size:0.8rem;color:var(--color-text-light);line-height:1.5;max-height:200px;overflow-y:auto;">' + fly.recipe + '</pre></details>'
                    : '';

                var isFav = isFavorite(fly.name);
                var flyData = encodeURIComponent(JSON.stringify(fly));

                card.innerHTML =
                    '<div class="card-image">' +
                        '<img src="' + fly.image + '" alt="' + fly.name + '" loading="lazy" onerror="this.src=\'https://images.pexels.com/photos/3099227/pexels-photo-3099227.jpeg?auto=compress&cs=tinysrgb&w=600\'">' +
                        '<button class="favorite-btn ' + (isFav ? 'active' : '') + '" onclick="toggleFavorite(JSON.parse(decodeURIComponent(\'' + flyData + '\')))" title="' + (isFav ? 'Remove from favorites' : 'Add to favorites') + '">' +
                            (isFav ? '&#9829;' : '&#9825;') +
                        '</button>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<span class="card-tag">' + fly.type + '</span>' +
                        '<h3>' + fly.name + '</h3>' +
                        '<p style="font-size:0.85rem;margin-bottom:0.35rem;"><strong>Best for:</strong> ' + fly.bestFor + '</p>' +
                        '<p>' + fly.description + '</p>' +
                        recipePreview +
                        '<button class="btn btn-sm btn-dark add-to-list-btn" onclick="addToList(JSON.parse(decodeURIComponent(\'' + flyData + '\')))">' +
                            '+ Add to List' +
                        '</button>' +
                    '</div>';
                grid.appendChild(card);
            });

            // Re-observe for animations
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) entry.target.classList.add('visible');
                });
            }, { threshold: 0.1 });
            grid.querySelectorAll('.animate-on-scroll').forEach(function(el) { observer.observe(el); });
        }

        function filterAndSearch() {
            renderFlies(allFlies);
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', filterAndSearch);

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                activeFilter = btn.getAttribute('data-filter');
                filterAndSearch();
            });
        });
    </script>
</body>
</html>
