<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a2e1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Admin - On Point Flies</title>
    <meta name="description" content="Admin panel for On Point Flies inventory management.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Auth0 SPA SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="mobile-detect.js"></script>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo"><img src="logo.jpeg" alt="On Point Flies logo" class="nav-logo-img">On Point <span>Flies</span></a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="catalog.html">Catalog</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="order.html">Order</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="admin.html" class="active">Admin</a></li>
            </ul>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span><span></span><span></span>
            </button>
        </div>
    </nav>

    <!-- Page Hero -->
    <section class="page-hero page-hero-small">
        <div class="hero-bg" style="background-image: url('https://images.pexels.com/photos/3099227/pexels-photo-3099227.jpeg?auto=compress&cs=tinysrgb&w=1920');"></div>
        <div class="hero-content">
            <span class="section-label">Protected Area</span>
            <h1>Admin Panel</h1>
            <p>Manage your fly inventory and catalog.</p>
        </div>
    </section>

    <!-- Admin Content -->
    <section class="section">
        <div class="container">

            <!-- Login Section (shown when not authenticated) -->
            <div id="auth-section" class="admin-auth-card">
                <div class="auth-icon">&#128274;</div>
                <h2>Admin Login Required</h2>
                <p>Please log in with your Auth0 account to access the admin panel.</p>
                <button id="login-btn" class="btn btn-primary" style="margin-top:1.5rem;">
                    Log In with Auth0
                </button>
                <div id="auth-error" class="auth-error" style="display:none;"></div>
            </div>

            <!-- Not Authorized Section (shown when user is not admin) -->
            <div id="not-authorized-section" class="admin-auth-card" style="display:none;">
                <div class="auth-icon">&#128683;</div>
                <h2>Access Denied</h2>
                <p>Your account does not have admin privileges. Only users with the <strong>admin</strong> role can manage inventory and catalog.</p>
                <p id="not-auth-user-info" style="display:none;margin-top:0.75rem;padding:0.5rem 1rem;background:#f5f5f5;border-radius:6px;font-size:0.95rem;color:#333;"></p>
                <p style="margin-top:1rem;color:#666;">If you believe you should have admin access, make sure your email is listed in the <strong>ADMIN_EMAILS</strong> environment variable, then log out and log back in.</p>
                <button id="not-auth-logout-btn" class="btn btn-outline-dark" style="margin-top:1.5rem;">Log Out</button>
            </div>

            <!-- Admin Dashboard (shown when authenticated) -->
            <div id="admin-dashboard" style="display:none;">
                
                <!-- User Info Bar -->
                <div class="admin-user-bar">
                    <div class="user-info">
                        <img id="user-avatar" src="" alt="User avatar" class="user-avatar">
                        <div>
                            <span class="user-greeting">Welcome back,</span>
                            <strong id="user-name"></strong>
                        </div>
                    </div>
                    <button id="logout-btn" class="btn btn-outline-dark">Log Out</button>
                </div>

                <!-- Admin Tabs -->
                <div class="admin-tabs">
                    <button class="admin-tab active" data-panel="inventory-panel">Inventory</button>
                    <button class="admin-tab" data-panel="catalog-panel">Catalog</button>
                    <button class="admin-tab" data-panel="uploads-panel">Uploads</button>
                    <button class="admin-tab" data-panel="export-panel">Export Data</button>
                    <button class="admin-tab" data-panel="users-panel">Users</button>
                </div>

                <!-- Inventory Panel -->
                <div id="inventory-panel" class="admin-panel active">
                    <div class="panel-header">
                        <h3>Inventory Management</h3>
                        <button class="btn btn-primary btn-sm" onclick="addInventoryItem()">+ Add Item</button>
                    </div>
                    
                    <div class="admin-filters">
                        <input type="text" id="admin-search" placeholder="Search inventory..." class="admin-input">
                        <select id="admin-category" class="admin-select">
                            <option value="all">All Categories</option>
                            <option value="streamers">Streamers</option>
                            <option value="nymphs">Nymphs</option>
                            <option value="dryflies">Dry Flies</option>
                        </select>
                    </div>

                    <div class="table-wrap">
                        <table class="styled-table admin-table" id="inventory-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Size</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Catalog Panel -->
                <div id="catalog-panel" class="admin-panel">
                    <div class="panel-header">
                        <h3>Catalog Management</h3>
                        <button class="btn btn-primary btn-sm" onclick="addCatalogItem()">+ Add Fly Pattern</button>
                    </div>
                    <div class="catalog-admin-grid" id="catalog-admin-grid"></div>
                </div>

                <!-- Uploads Panel -->
                <div id="uploads-panel" class="admin-panel">
                    <div class="panel-header">
                        <h3>File & Image Uploads</h3>
                        <p>Upload images and files for your catalog and inventory items.</p>
                    </div>

                    <!-- Upload Drop Zone -->
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-zone-content">
                            <div class="upload-icon">&#128247;</div>
                            <h4>Drag & Drop Files Here</h4>
                            <p>or click to browse. Max 5 MB per file.</p>
                            <p class="upload-formats">Accepted: JPEG, PNG, GIF, WebP, PDF, CSV, JSON</p>
                        </div>
                        <input type="file" id="upload-file-input" multiple accept="image/jpeg,image/png,image/gif,image/webp,application/pdf,text/csv,application/json" style="display:none;">
                    </div>

                    <!-- Upload Target -->
                    <div class="upload-options">
                        <label for="upload-target">Assign to:</label>
                        <select id="upload-target" class="admin-select">
                            <option value="general">General</option>
                            <option value="catalog">Catalog</option>
                            <option value="inventory">Inventory</option>
                        </select>
                    </div>

                    <!-- Upload Progress -->
                    <div id="upload-progress" class="upload-progress" style="display:none;">
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" id="upload-progress-fill"></div>
                        </div>
                        <span id="upload-progress-text">Uploading...</span>
                    </div>

                    <!-- Uploaded Files Grid -->
                    <div class="upload-filter-bar">
                        <button class="filter-btn active" onclick="filterUploads('all', this)">All</button>
                        <button class="filter-btn" onclick="filterUploads('catalog', this)">Catalog</button>
                        <button class="filter-btn" onclick="filterUploads('inventory', this)">Inventory</button>
                        <button class="filter-btn" onclick="filterUploads('general', this)">General</button>
                    </div>
                    <div class="uploads-grid" id="uploads-grid">
                        <div class="empty-state">
                            <span class="empty-icon">&#128193;</span>
                            <h4>No files uploaded yet</h4>
                            <p>Upload images and files above to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Export Panel -->
                <div id="export-panel" class="admin-panel">
                    <div class="panel-header">
                        <h3>Export Data</h3>
                    </div>
                    <div class="export-options">
                        <div class="export-card">
                            <h4>Export Inventory</h4>
                            <p>Download your current inventory data as JSON for backup or migration.</p>
                            <button class="btn btn-dark" onclick="exportInventory()">Download Inventory JSON</button>
                        </div>
                        <div class="export-card">
                            <h4>Export Catalog</h4>
                            <p>Download your fly catalog (flies.json) with all patterns and recipes.</p>
                            <button class="btn btn-dark" onclick="exportCatalog()">Download Catalog JSON</button>
                        </div>
                        <div class="export-card">
                            <h4>Import Data</h4>
                            <p>Upload a JSON file to update your inventory or catalog data.</p>
                            <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(event)">
                            <button class="btn btn-outline-dark" onclick="document.getElementById('import-file').click()">Import JSON File</button>
                        </div>
                    </div>
                </div>

                <!-- Users Panel (admin role management) -->
                <div id="users-panel" class="admin-panel">
                    <div class="panel-header">
                        <h3>User Management</h3>
                        <p>Manage user roles. Admins can manage inventory, catalog, and uploads.</p>
                    </div>
                    <div class="table-wrap">
                        <table class="styled-table admin-table" id="users-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody"></tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>
    </section>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal" style="display:none;">
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Item</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="edit-form" onsubmit="saveItem(event)">
                <div id="modal-fields"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline-dark" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-brand">
                <h3><img src="logo.jpeg" alt="On Point Flies logo" class="footer-logo-img">On Point <span>Flies</span></h3>                <p>Premium hand-tied flies for the passionate fly fisher. From classic patterns to custom creations, we tie flies that catch fish.</p>
            </div>
            <div>
                <h4>Navigate</h4>
                <ul class="footer-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="catalog.html">Catalog</a></li>
                    <li><a href="inventory.html">Inventory</a></li>
                </ul>
            </div>
            <div>
                <h4>Orders</h4>
                <ul class="footer-links">
                    <li><a href="order.html">How to Order</a></li>
                    <li><a href="order.html">Pricing</a></li>
                    <li><a href="order.html">Shipping</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <div>
                <h4>Get in Touch</h4>
                <ul class="footer-links">
                    <li><a href="mailto:info@onpointflies.com">info@onpointflies.com</a></li>
                    <li style="margin-top:0.5rem;"><a href="contact.html">Send us a message &rarr;</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 On Point Flies. All rights reserved.</p>
        </div>
    </footer>

    <script src="api.js"></script>
    <script>
        // Auth0 Configuration
        const AUTH0_CONFIG = {
            domain: '',
            clientId: '',
            redirectUri: window.location.origin + '/admin.html'
        };

        async function loadAuth0Config() {
            var resp = await fetch('/api/auth-config');
            var config = await resp.json();
            AUTH0_CONFIG.domain = config.domain;
            AUTH0_CONFIG.clientId = config.clientId;
        }

        let auth0Client = null;
        let isAuthenticated = false;
        let currentUserRole = null;

        let inventoryData = [];
        let catalogData = [];
        let uploadedFiles = [];
        let currentUploadFilter = 'all';
        let usersData = [];

        // Auth0 Initialization
        async function initAuth0() {
            try {
                await loadAuth0Config();
                auth0Client = await auth0.createAuth0Client({
                    domain: AUTH0_CONFIG.domain,
                    clientId: AUTH0_CONFIG.clientId,
                    cacheLocation: 'localstorage',
                    authorizationParams: {
                        redirect_uri: AUTH0_CONFIG.redirectUri,
                        scope: 'openid profile email'
                    }
                });

                if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                isAuthenticated = await auth0Client.isAuthenticated();

                if (isAuthenticated) {
                    await showAdminDashboard();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Auth0 initialization error:', error);
                showAuthError('Failed to initialize authentication: ' + error.message);
            }
        }

        async function login() {
            if (!auth0Client) {
                showAuthError('Auth0 is not configured.');
                return;
            }
            try {
                await auth0Client.loginWithRedirect();
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('Login failed: ' + error.message);
            }
        }

        async function logout() {
            if (!auth0Client) return;
            await auth0Client.logout({ logoutParams: { returnTo: window.location.origin } });
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showLoginScreen() {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('admin-dashboard').style.display = 'none';
        }

        async function showAdminDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            await OPF_API.setToken(auth0Client);

            // If we couldn't get a token at all, force re-login immediately
            if (!OPF_API.token) {
                console.warn('No auth token available — forcing re-login');
                if (!sessionStorage.getItem('opf_reauth')) {
                    sessionStorage.setItem('opf_reauth', '1');
                    await auth0Client.loginWithRedirect({
                        authorizationParams: {
                            redirect_uri: AUTH0_CONFIG.redirectUri,
                            scope: 'openid profile email',
                            prompt: 'login'
                        }
                    });
                    return;
                }
                sessionStorage.removeItem('opf_reauth');
            }

            // Sync user and check role — retry once on failure (e.g. stale token)
            var syncError = null;
            var syncErrorCode = null;
            var userData = null;
            for (var attempt = 0; attempt < 2; attempt++) {
                try {
                    userData = await OPF_API.syncUser();
                    currentUserRole = userData.role || 'user';
                    syncError = null;
                    syncErrorCode = null;
                    break;
                } catch (err) {
                    console.error('Sync attempt ' + (attempt + 1) + ' failed:', err);
                    syncError = err;
                    // Try to extract the errorCode from the error message
                    try {
                        var errMsg = err.message || '';
                        // The server returns JSON with errorCode — but our request()
                        // method wraps it in an Error. Check if it was parsed.
                        syncErrorCode = err.errorCode || null;
                    } catch (_) {}
                    currentUserRole = 'user';
                    // On first failure refresh the token and retry
                    if (attempt === 0) {
                        await OPF_API.setToken(auth0Client);
                    }
                }
            }

            // If sync failed (token expired/invalid), force a fresh login
            // Use sessionStorage flag to prevent infinite redirect loops
            if (syncError && !sessionStorage.getItem('opf_reauth')) {
                console.warn('Server sync failed — forcing fresh login');
                sessionStorage.setItem('opf_reauth', '1');
                await auth0Client.loginWithRedirect({
                    authorizationParams: {
                        redirect_uri: AUTH0_CONFIG.redirectUri,
                        scope: 'openid profile email',
                        prompt: 'login'
                    }
                });
                return;
            }
            // Clear the re-auth flag — we either succeeded or already retried
            sessionStorage.removeItem('opf_reauth');

            if (currentUserRole !== 'admin') {
                document.getElementById('not-authorized-section').style.display = 'block';
                document.getElementById('admin-dashboard').style.display = 'none';
                // Show the user's email so they can verify it matches ADMIN_EMAILS
                try {
                    var authUser = await auth0Client.getUser();
                    var infoEl = document.getElementById('not-auth-user-info');
                    if (infoEl && authUser) {
                        infoEl.textContent = 'Logged in as: ' + (authUser.email || authUser.name || 'unknown');
                        infoEl.style.display = 'block';
                    }
                } catch (e) { /* ignore */ }
                // Show server-side diagnosis to help debug admin detection
                if (userData && userData._diagnosis) {
                    var d = userData._diagnosis;
                    var diagEl = document.getElementById('not-auth-user-info');
                    if (diagEl) {
                        var hints = [];
                        if (!d.emailInToken) hints.push('Email is MISSING from the Auth0 token — add an Auth0 Login Action to include it');
                        if (!d.adminEmailsConfigured) hints.push('ADMIN_EMAILS env var is not configured on the server');
                        if (d.emailInToken && d.adminEmailsConfigured && !d.emailMatchesAdminList) hints.push('Server email (' + (userData.email || 'none') + ') does not match ADMIN_EMAILS');
                        if (hints.length) {
                            diagEl.innerHTML += '<br><br><strong>Diagnosis:</strong><br>' + hints.join('<br>');
                        }
                    }
                }
                if (syncError) {
                    console.error('Admin check failed due to sync error after re-login.');
                    var infoEl2 = document.getElementById('not-auth-user-info');
                    if (infoEl2) {
                        infoEl2.textContent += ' (Error: ' + syncError.message + ' — please contact support)';
                    }
                }
                return;
            }

            document.getElementById('not-authorized-section').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            const user = await auth0Client.getUser();
            document.getElementById('user-name').textContent = user.name || user.email;
            document.getElementById('user-avatar').src = user.picture || 'https://via.placeholder.com/40';
            await loadCatalog();
            await loadInventory();
            await loadUploads();
            initUploadZone();
        }

        // Data Management — loads from Netlify Blobs via API
        async function loadCatalog() {
            try {
                catalogData = await OPF_API.getCatalog();
                renderCatalogAdmin();
            } catch (error) {
                console.error('Error loading catalog:', error);
            }
        }

        async function loadInventory() {
            try {
                inventoryData = await OPF_API.getInventory();
                renderInventory();
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        async function loadUploads() {
            try {
                uploadedFiles = await OPF_API.getUploadedFiles();
                renderUploads();
            } catch (error) {
                console.error('Error loading uploads:', error);
                uploadedFiles = [];
            }
        }

        function renderInventory() {
            const tbody = document.getElementById('inventory-tbody');
            const searchTerm = document.getElementById('admin-search').value.toLowerCase();
            const categoryFilter = document.getElementById('admin-category').value;

            let filtered = inventoryData;
            if (searchTerm) {
                filtered = filtered.filter(function(item) { return item.name.toLowerCase().includes(searchTerm); });
            }
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(function(item) { return item.category === categoryFilter; });
            }

            tbody.innerHTML = filtered.map(function(item) {
                var imgCell = item.image
                    ? '<img src="' + item.image + '" alt="' + item.name + '" class="table-thumb" onerror="this.style.display=\'none\'">'
                    : '';
                return '<tr>' +
                    '<td>' + imgCell + ' ' + item.name + '</td>' +
                    '<td><span class="card-tag">' + item.category + '</span></td>' +
                    '<td>' + item.size + '</td>' +
                    '<td>' + item.qty + '</td>' +
                    '<td>$' + item.price.toFixed(2) + '</td>' +
                    '<td>' +
                        '<button class="btn-icon" onclick="editInventoryItem(' + item.id + ')" title="Edit">&#9998;</button>' +
                        '<button class="btn-icon btn-icon-danger" onclick="deleteInventoryItem(' + item.id + ')" title="Delete">&#128465;</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function renderCatalogAdmin() {
            const grid = document.getElementById('catalog-admin-grid');
            grid.innerHTML = catalogData.map(function(fly, index) {
                return '<div class="catalog-admin-card">' +
                    '<img src="' + fly.image + '" alt="' + fly.name + '" onerror="this.src=\'https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Black_Woolly_Bugger_by_James_Stripes.jpg/600px-Black_Woolly_Bugger_by_James_Stripes.jpg\'">' +
                    '<div class="catalog-admin-card-body">' +
                        '<span class="card-tag">' + fly.type + '</span>' +
                        '<h4>' + fly.name + '</h4>' +
                        '<p>' + fly.bestFor + '</p>' +
                        '<div class="catalog-admin-actions">' +
                            '<button class="btn-icon" onclick="editCatalogItem(' + index + ')" title="Edit">&#9998;</button>' +
                            '<button class="btn-icon btn-icon-danger" onclick="deleteCatalogItem(' + index + ')" title="Delete">&#128465;</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Upload Management
        function initUploadZone() {
            var zone = document.getElementById('upload-zone');
            var input = document.getElementById('upload-file-input');

            zone.addEventListener('click', function() { input.click(); });

            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', function() {
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files);
                }
            });

            input.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files);
                }
                e.target.value = '';
            });
        }

        async function handleFileUpload(files) {
            var target = document.getElementById('upload-target').value;
            var progressDiv = document.getElementById('upload-progress');
            var progressFill = document.getElementById('upload-progress-fill');
            var progressText = document.getElementById('upload-progress-text');

            progressDiv.style.display = 'block';
            var total = files.length;
            var completed = 0;

            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                progressText.textContent = 'Uploading ' + (i + 1) + ' of ' + total + ': ' + file.name;
                progressFill.style.width = ((completed / total) * 100) + '%';

                try {
                    var result = await OPF_API.uploadFile(file, target);
                    if (result && result.file) {
                        uploadedFiles.push(result.file);
                    }
                    completed++;
                } catch (err) {
                    alert('Failed to upload ' + file.name + ': ' + err.message);
                    completed++;
                }
            }

            progressFill.style.width = '100%';
            progressText.textContent = 'Upload complete!';
            setTimeout(function() { progressDiv.style.display = 'none'; }, 2000);

            renderUploads();
        }

        function renderUploads() {
            var grid = document.getElementById('uploads-grid');
            var filtered = currentUploadFilter === 'all'
                ? uploadedFiles
                : uploadedFiles.filter(function(f) { return f.target === currentUploadFilter; });

            if (!filtered || filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state">' +
                    '<span class="empty-icon">&#128193;</span>' +
                    '<h4>No files uploaded yet</h4>' +
                    '<p>Upload images and files above to get started.</p>' +
                '</div>';
                return;
            }

            grid.innerHTML = filtered.map(function(file) {
                var isImage = file.contentType && file.contentType.startsWith('image/');
                var fileUrl = file.url || ('/api/upload?key=' + encodeURIComponent(file.key));
                var preview = isImage
                    ? '<img src="' + fileUrl + '" alt="' + file.fileName + '" class="upload-thumb">'
                    : '<div class="upload-file-icon">&#128196;</div>';

                return '<div class="upload-card">' +
                    preview +
                    '<div class="upload-card-body">' +
                        '<h4 title="' + file.fileName + '">' + truncate(file.fileName, 24) + '</h4>' +
                        '<span class="card-tag">' + file.target + '</span>' +
                        '<p class="upload-meta">' + formatFileSize(file.size) + '</p>' +
                        '<div class="upload-card-actions">' +
                            '<button class="btn-icon" onclick="copyUploadUrl(\'' + fileUrl + '\')" title="Copy URL">&#128203;</button>' +
                            '<button class="btn-icon btn-icon-danger" onclick="deleteUpload(\'' + file.key + '\')" title="Delete">&#128465;</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function filterUploads(filter, btn) {
            currentUploadFilter = filter;
            document.querySelectorAll('.upload-filter-bar .filter-btn').forEach(function(b) { b.classList.remove('active'); });
            if (btn) btn.classList.add('active');
            renderUploads();
        }

        function copyUploadUrl(url) {
            var fullUrl = window.location.origin + url;
            navigator.clipboard.writeText(fullUrl).then(function() {
                showToast('URL copied to clipboard!');
            }).catch(function() {
                // Fallback
                prompt('Copy this URL:', fullUrl);
            });
        }

        async function deleteUpload(key) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            try {
                var result = await OPF_API.deleteUploadedFile(key);
                uploadedFiles = result.files || uploadedFiles.filter(function(f) { return f.key !== key; });
                renderUploads();
                showToast('File deleted');
            } catch (err) {
                alert('Failed to delete file: ' + err.message);
            }
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len - 3) + '...' : str;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showToast(message) {
            var existing = document.querySelector('.toast');
            if (existing) existing.remove();
            var toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.classList.add('show'); }, 10);
            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() { toast.remove(); }, 300);
            }, 2500);
        }

        // Image upload helper for modals
        function createImageUploadField(fieldId, currentUrl, target) {
            return '<div class="form-group">' +
                '<label>Image</label>' +
                '<div class="image-upload-group">' +
                    '<div class="image-preview-wrap" id="' + fieldId + '-preview-wrap" style="' + (currentUrl ? '' : 'display:none') + '">' +
                        '<img src="' + (currentUrl || '') + '" class="image-preview" id="' + fieldId + '-preview" onerror="this.parentElement.style.display=\'none\'">' +
                    '</div>' +
                    '<div class="image-upload-options">' +
                        '<div class="image-option">' +
                            '<label>Upload Image</label>' +
                            '<div class="modal-upload-zone" id="' + fieldId + '-dropzone" ' +
                                'onclick="document.getElementById(\'' + fieldId + '-file\').click()" ' +
                                'ondragover="event.preventDefault(); this.classList.add(\'drag-over\')" ' +
                                'ondragleave="this.classList.remove(\'drag-over\')" ' +
                                'ondrop="event.preventDefault(); this.classList.remove(\'drag-over\'); if(event.dataTransfer.files.length) { document.getElementById(\'' + fieldId + '-file\').files = event.dataTransfer.files; handleModalFileSelect(document.getElementById(\'' + fieldId + '-file\'), \'' + fieldId + '\', \'' + target + '\'); }">' +
                                '<div class="modal-upload-icon">&#128247;</div>' +
                                '<span class="modal-upload-text">Click or drag an image here</span>' +
                                '<span class="modal-upload-hint">JPEG, PNG, GIF, WebP &mdash; max 5 MB</span>' +
                                '<span id="' + fieldId + '-filename" class="upload-filename"></span>' +
                            '</div>' +
                            '<input type="file" id="' + fieldId + '-file" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none" onchange="handleModalFileSelect(this, \'' + fieldId + '\', \'' + target + '\')">' +
                        '</div>' +
                        '<div class="image-option-divider">' +
                            '<button type="button" class="btn-toggle-url" onclick="toggleUrlInput(\'' + fieldId + '\')">' +
                                'Or paste an image URL instead' +
                            '</button>' +
                        '</div>' +
                        '<div class="image-option image-url-option" id="' + fieldId + '-url-wrap" style="display:none">' +
                            '<label for="' + fieldId + '-url">Image URL</label>' +
                            '<input type="url" id="' + fieldId + '-url" value="' + (currentUrl || '') + '" placeholder="https://..." onchange="updateImagePreview(\'' + fieldId + '\')">' +
                        '</div>' +
                    '</div>' +
                    '<input type="hidden" id="' + fieldId + '-url-hidden" value="' + (currentUrl || '') + '">' +
                '</div>' +
            '</div>';
        }

        function toggleUrlInput(fieldId) {
            var wrap = document.getElementById(fieldId + '-url-wrap');
            var isHidden = wrap.style.display === 'none';
            wrap.style.display = isHidden ? '' : 'none';
            if (isHidden) {
                var urlInput = document.getElementById(fieldId + '-url');
                var hiddenVal = document.getElementById(fieldId + '-url-hidden').value;
                if (hiddenVal && !urlInput.value) urlInput.value = hiddenVal;
                urlInput.focus();
            }
        }

        function updateImagePreview(fieldId) {
            var urlInput = document.getElementById(fieldId + '-url');
            var url = urlInput ? urlInput.value : '';
            // Also update hidden field
            var hidden = document.getElementById(fieldId + '-url-hidden');
            if (hidden) hidden.value = url;
            var previewWrap = document.getElementById(fieldId + '-preview-wrap');
            var existing = document.getElementById(fieldId + '-preview');
            if (existing) {
                existing.src = url;
                if (previewWrap) previewWrap.style.display = url ? '' : 'none';
            } else if (url && previewWrap) {
                previewWrap.innerHTML = '<img src="' + url + '" class="image-preview" id="' + fieldId + '-preview" onerror="this.parentElement.style.display=\'none\'">';
                previewWrap.style.display = '';
            } else if (url) {
                var group = document.querySelector('.image-upload-group');
                if (group) {
                    var pw = document.createElement('div');
                    pw.className = 'image-preview-wrap';
                    pw.id = fieldId + '-preview-wrap';
                    pw.innerHTML = '<img src="' + url + '" class="image-preview" id="' + fieldId + '-preview" onerror="this.parentElement.style.display=\'none\'">';
                    group.insertBefore(pw, group.firstChild);
                }
            }
        }

        async function handleModalFileSelect(input, fieldId, target) {
            var file = input.files[0];
            if (!file) return;
            var filenameSpan = document.getElementById(fieldId + '-filename');
            var dropzone = document.getElementById(fieldId + '-dropzone');
            filenameSpan.textContent = file.name;

            try {
                filenameSpan.textContent = 'Uploading ' + file.name + '...';
                if (dropzone) dropzone.classList.add('uploading');
                var result = await OPF_API.uploadFile(file, target);
                if (result && result.file) {
                    var url = result.file.url;
                    // Update the visible URL field if it exists
                    var urlInput = document.getElementById(fieldId + '-url');
                    if (urlInput) urlInput.value = url;
                    // Always update the hidden field
                    var hidden = document.getElementById(fieldId + '-url-hidden');
                    if (hidden) hidden.value = url;
                    updateImagePreview(fieldId);
                    filenameSpan.textContent = file.name + ' — uploaded successfully';
                    filenameSpan.classList.add('upload-success');
                    uploadedFiles.push(result.file);
                }
            } catch (err) {
                filenameSpan.textContent = 'Upload failed — ' + err.message;
                filenameSpan.classList.add('upload-error');
            } finally {
                if (dropzone) dropzone.classList.remove('uploading');
            }
        }

        // CRUD Operations
        let currentEditType = null;
        let currentEditId = null;

        function addInventoryItem() {
            currentEditType = 'inventory';
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Add Inventory Item';
            document.getElementById('modal-fields').innerHTML =
                '<div class="form-group"><label for="item-name">Name</label><input type="text" id="item-name" required></div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-category">Category</label>' +
                        '<select id="item-category" required><option value="streamers">Streamers</option><option value="nymphs">Nymphs</option><option value="dryflies">Dry Flies</option></select>' +
                    '</div>' +
                    '<div class="form-group"><label for="item-subcategory">Subcategory</label><input type="text" id="item-subcategory" placeholder="e.g., Woolly Buggers"></div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-size">Size</label><input type="text" id="item-size" required></div>' +
                    '<div class="form-group"><label for="item-qty">Quantity</label><input type="number" id="item-qty" min="0" required></div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-price">Price ($)</label><input type="number" id="item-price" step="0.01" min="0" required></div>' +
                    '<div class="form-group"><label for="item-startingqty">Starting Qty</label><input type="number" id="item-startingqty" min="0"></div>' +
                '</div>' +
                createImageUploadField('item-image', '', 'inventory');
            openModal();
        }

        function editInventoryItem(id) {
            currentEditType = 'inventory';
            currentEditId = id;
            var item = inventoryData.find(function(i) { return i.id === id; });
            if (!item) return;
            document.getElementById('modal-title').textContent = 'Edit Inventory Item';
            document.getElementById('modal-fields').innerHTML =
                '<div class="form-group"><label for="item-name">Name</label><input type="text" id="item-name" value="' + item.name + '" required></div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-category">Category</label>' +
                        '<select id="item-category" required><option value="streamers"' + (item.category === 'streamers' ? ' selected' : '') + '>Streamers</option><option value="nymphs"' + (item.category === 'nymphs' ? ' selected' : '') + '>Nymphs</option><option value="dryflies"' + (item.category === 'dryflies' ? ' selected' : '') + '>Dry Flies</option></select>' +
                    '</div>' +
                    '<div class="form-group"><label for="item-subcategory">Subcategory</label><input type="text" id="item-subcategory" value="' + (item.subcategory || '') + '"></div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-size">Size</label><input type="text" id="item-size" value="' + item.size + '" required></div>' +
                    '<div class="form-group"><label for="item-qty">Quantity</label><input type="number" id="item-qty" value="' + item.qty + '" min="0" required></div>' +
                '</div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="item-price">Price ($)</label><input type="number" id="item-price" value="' + item.price + '" step="0.01" min="0" required></div>' +
                    '<div class="form-group"><label for="item-startingqty">Starting Qty</label><input type="number" id="item-startingqty" value="' + (item.startingQty || '') + '" min="0"></div>' +
                '</div>' +
                createImageUploadField('item-image', item.image || '', 'inventory');
            openModal();
        }

        async function deleteInventoryItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                var result = await OPF_API.deleteInventoryItem(id);
                inventoryData = result.inventory;
                renderInventory();
            } catch (err) {
                alert('Failed to delete item: ' + err.message);
            }
        }

        function addCatalogItem() {
            currentEditType = 'catalog';
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Add Fly Pattern';
            document.getElementById('modal-fields').innerHTML =
                '<div class="form-group"><label for="fly-name">Name</label><input type="text" id="fly-name" required></div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="fly-type">Type</label>' +
                        '<select id="fly-type" required><option value="Streamer">Streamer</option><option value="Nymph">Nymph</option><option value="Dry Fly">Dry Fly</option><option value="Material">Material</option></select>' +
                    '</div>' +
                    '<div class="form-group"><label for="fly-bestfor">Best For</label><input type="text" id="fly-bestfor" placeholder="e.g., trout, bass" required></div>' +
                '</div>' +
                '<div class="form-group"><label for="fly-description">Description</label><textarea id="fly-description" rows="3"></textarea></div>' +
                createImageUploadField('fly-image', '', 'catalog') +
                '<div class="form-group"><label for="fly-recipe">Recipe</label><textarea id="fly-recipe" rows="5" placeholder="Hook: ..."></textarea></div>';
            openModal();
        }

        function editCatalogItem(index) {
            currentEditType = 'catalog';
            currentEditId = index;
            var fly = catalogData[index];
            if (!fly) return;
            document.getElementById('modal-title').textContent = 'Edit Fly Pattern';
            document.getElementById('modal-fields').innerHTML =
                '<div class="form-group"><label for="fly-name">Name</label><input type="text" id="fly-name" value="' + fly.name + '" required></div>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label for="fly-type">Type</label>' +
                        '<select id="fly-type" required><option value="Streamer"' + (fly.type === 'Streamer' ? ' selected' : '') + '>Streamer</option><option value="Nymph"' + (fly.type === 'Nymph' ? ' selected' : '') + '>Nymph</option><option value="Dry Fly"' + (fly.type === 'Dry Fly' ? ' selected' : '') + '>Dry Fly</option><option value="Material"' + (fly.type === 'Material' ? ' selected' : '') + '>Material</option></select>' +
                    '</div>' +
                    '<div class="form-group"><label for="fly-bestfor">Best For</label><input type="text" id="fly-bestfor" value="' + fly.bestFor + '" required></div>' +
                '</div>' +
                '<div class="form-group"><label for="fly-description">Description</label><textarea id="fly-description" rows="3">' + (fly.description || '') + '</textarea></div>' +
                createImageUploadField('fly-image', fly.image || '', 'catalog') +
                '<div class="form-group"><label for="fly-recipe">Recipe</label><textarea id="fly-recipe" rows="5">' + (fly.recipe || '') + '</textarea></div>';
            openModal();
        }

        async function deleteCatalogItem(index) {
            if (!confirm('Are you sure you want to delete this fly pattern?')) return;
            try {
                var result = await OPF_API.deleteCatalogItem(index);
                catalogData = result.catalog;
                renderCatalogAdmin();
            } catch (err) {
                alert('Failed to delete fly pattern: ' + err.message);
            }
        }

        async function saveItem(event) {
            event.preventDefault();
            try {
                if (currentEditType === 'inventory') {
                    var imageUrlEl = document.getElementById('item-image-url');
                    var imageHiddenEl = document.getElementById('item-image-url-hidden');
                    var imageUrl = (imageUrlEl ? imageUrlEl.value : '') || (imageHiddenEl ? imageHiddenEl.value : '');
                    var item = {
                        name: document.getElementById('item-name').value,
                        category: document.getElementById('item-category').value,
                        subcategory: document.getElementById('item-subcategory').value,
                        size: document.getElementById('item-size').value,
                        qty: parseInt(document.getElementById('item-qty').value),
                        price: parseFloat(document.getElementById('item-price').value),
                        startingQty: parseInt(document.getElementById('item-startingqty').value) || parseInt(document.getElementById('item-qty').value),
                        image: imageUrl,
                    };
                    var result;
                    if (currentEditId) {
                        item.id = currentEditId;
                        result = await OPF_API.updateInventoryItem(item);
                    } else {
                        result = await OPF_API.addInventoryItem(item);
                    }
                    inventoryData = result.inventory;
                    renderInventory();
                } else if (currentEditType === 'catalog') {
                    var fly = {
                        name: document.getElementById('fly-name').value,
                        type: document.getElementById('fly-type').value,
                        bestFor: document.getElementById('fly-bestfor').value,
                        description: document.getElementById('fly-description').value,
                        image: (document.getElementById('fly-image-url') ? document.getElementById('fly-image-url').value : '') || (document.getElementById('fly-image-url-hidden') ? document.getElementById('fly-image-url-hidden').value : ''),
                        recipe: document.getElementById('fly-recipe').value,
                    };
                    var result;
                    if (currentEditId !== null) {
                        fly.index = currentEditId;
                        result = await OPF_API.updateCatalogItem(fly);
                    } else {
                        result = await OPF_API.addCatalogItem(fly);
                    }
                    catalogData = result.catalog;
                    renderCatalogAdmin();
                }
                closeModal();
            } catch (err) {
                alert('Failed to save: ' + err.message);
            }
        }

        // Export / Import
        function exportInventory() { downloadJSON(inventoryData, 'inventory.json'); }
        function exportCatalog() { downloadJSON(catalogData, 'flies.json'); }

        // User Management
        async function loadUsers() {
            try {
                usersData = await OPF_API.getUsers();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsers() {
            var tbody = document.getElementById('users-tbody');
            if (!usersData || usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:2rem;">No users found.</td></tr>';
                return;
            }
            tbody.innerHTML = usersData.map(function(u) {
                var roleTag = u.role === 'admin'
                    ? '<span class="card-tag" style="background:#1a2e1a;color:#fff;">admin</span>'
                    : '<span class="card-tag">user</span>';
                var actionBtn = u.role === 'admin'
                    ? '<button class="btn btn-outline-dark btn-sm" onclick="toggleUserRole(\'' + u.auth0_id + '\', \'user\')">Demote to User</button>'
                    : '<button class="btn btn-primary btn-sm" onclick="toggleUserRole(\'' + u.auth0_id + '\', \'admin\')">Promote to Admin</button>';
                return '<tr>' +
                    '<td>' + (u.name || 'N/A') + '</td>' +
                    '<td>' + (u.email || 'N/A') + '</td>' +
                    '<td>' + roleTag + '</td>' +
                    '<td>' + actionBtn + '</td>' +
                '</tr>';
            }).join('');
        }

        async function toggleUserRole(auth0_id, newRole) {
            var action = newRole === 'admin' ? 'promote this user to admin' : 'demote this user to a regular user';
            if (!confirm('Are you sure you want to ' + action + '?')) return;
            try {
                await OPF_API.updateUserRole(auth0_id, newRole);
                await loadUsers();
            } catch (err) {
                alert('Failed to update role: ' + err.message);
            }
        }

        function downloadJSON(data, filename) {
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function handleImport(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (Array.isArray(data) && data.length > 0) {
                        if (data[0].hasOwnProperty('type') && data[0].hasOwnProperty('bestFor')) {
                            for (var i = 0; i < data.length; i++) {
                                await OPF_API.addCatalogItem(data[i]);
                            }
                            await loadCatalog();
                            alert('Catalog data imported successfully!');
                        } else if (data[0].hasOwnProperty('category') && data[0].hasOwnProperty('qty')) {
                            for (var i = 0; i < data.length; i++) {
                                await OPF_API.addInventoryItem(data[i]);
                            }
                            await loadInventory();
                            alert('Inventory data imported successfully!');
                        } else {
                            alert('Unknown data format.');
                        }
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // UI Helpers
        function openModal() {
            document.getElementById('edit-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initAuth0();

            var navbar = document.getElementById('navbar');
            window.addEventListener('scroll', function() {
                navbar.classList.toggle('scrolled', window.scrollY > 50);
            });


            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('not-auth-logout-btn').addEventListener('click', logout);

            document.querySelectorAll('.admin-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.admin-tab').forEach(function(t) { t.classList.remove('active'); });
                    document.querySelectorAll('.admin-panel').forEach(function(p) { p.classList.remove('active'); });
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.panel).classList.add('active');
                    // Lazy-load users when Users tab is first opened
                    if (tab.dataset.panel === 'users-panel' && usersData.length === 0) {
                        loadUsers();
                    }
                });
            });

            document.getElementById('admin-search').addEventListener('input', renderInventory);
            document.getElementById('admin-category').addEventListener('change', renderInventory);
        });
    </script>
</body>
</html>